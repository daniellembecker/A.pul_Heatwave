---
title: Respirometry Plotting and Analysis  
author: "AS Huffmyer"
date: '2022'
output:
  pdf_document:
    keep_tex: yes
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
This script analyzes and plots data. 

# **Setup**  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('effects')
library('emmeans')
library('multcomp')
```

# **Data visualization and manipulation**  

Load data from LoLinR.    
```{r, warning=FALSE, message=FALSE}
PRdata<-read.csv("output/oxygen_R_calc.csv") #load data
```

Separate project specific data.  
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that did not have samples or blanks
PRdata<-PRdata[!is.na(PRdata$Type),]

#format columns
PRdata$Meas.Temp<-as.factor(PRdata$Meas.Temp)
PRdata$Cohort<-as.factor(PRdata$Cohort)
PRdata$Treatment.Temp<-as.factor(PRdata$Treatment.Temp)
PRdata$SDR<-as.factor(PRdata$SDR)
PRdata$Run<-as.factor(PRdata$Run)
```

Look at the data distribution.   

```{r}
boxplot(PRdata$R.nmol.org.min)
```

For any R value that is >0, replace with 0. This will indicate no respiration, since oxygen production is not possible. This happens in cases where the respiration values were greater than the sample values. 

```{r}
PRdata<-PRdata%>%
  mutate(R.nmol.org.min=if_else(R.nmol.org.min>0, 0, R.nmol.org.min))
```

Calculate respiration rate as the inverse, so that more respiration = higher number. 
```{r}
PRdata<-PRdata%>%
  mutate(R.nmol.org.min=R.nmol.org.min*-1)
```

Calculate mean temperature values and reassign measurement treatment values if necessary.  

```{r}
resp.temps<-read.csv("output/Resp_runs_temp.csv")
resp.temps = subset(resp.temps, select = -c(X) ) #remove empty column

#format "run" column
resp.temps<-resp.temps %>% #Format as "#" rather than "Run#"
  mutate(Run = str_sub(Run, 4, -1))
resp.temps$Run<-as.integer(resp.temps$Run) #format as integer
resp.temps$Run<-as.factor(resp.temps$Run) #format as factor
```

Add temperature data to master data frame.  
```{r}
PRdata<-left_join(PRdata,resp.temps)

#round to 0.1Â°C 
PRdata<-PRdata%>%
  mutate(Temp.C=round(Temp.C,1))

PRdata<-PRdata%>%
  group_by(Run)%>%
  mutate(Actual.Temp=mean(Temp.C))%>%
  mutate(Actual.Temp=round(Actual.Temp,1))%>%
  mutate(Actual.Temp=as.factor(Actual.Temp))
```

You can use the above information to plot respiration by temperature if desired. 

# **Plotting**  

## Plot by treatment groups    

Plot data by Run as mean and standard error.    
```{r}
r_plot1<-PRdata %>%
    group_by(Treatment.Temp, Meas.Temp)%>%
    dplyr::summarise(mean=mean(R.nmol.org.min), sd=sd(R.nmol.org.min), N=length(R.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(Meas.Temp), y = mean)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Treatment.Temp, Meas.Temp)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot1

ggsave("figures/respirometry/resp_treatment_means.png", r_plot1, dpi=300, w=7, h=5, units="in")
```

Plot data by Run as mean and standard error by cohort.    
```{r}
r_plot1a<-PRdata %>%
    group_by(Treatment.Temp, Meas.Temp, Cohort)%>%
    dplyr::summarise(mean=mean(R.nmol.org.min), sd=sd(R.nmol.org.min), N=length(R.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(Meas.Temp), y = mean)) +
    facet_wrap(~Cohort)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Treatment.Temp, Actual.Temp)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot1a

ggsave("figures/respirometry/resp_treatment_means_cohort.png", r_plot1a, dpi=300, w=7, h=5, units="in")
```

Plot as a box plot. 
```{r}
r_plot2<-PRdata %>%
    
    ggplot(., aes(x = as.factor(Meas.Temp), y = R.nmol.org.min)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=4, position = position_jitterdodge(0.2)) + 
    geom_boxplot(aes(colour=Treatment.Temp), fill=NA, position = position_dodge(0.8), outlier.size = 0)+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot2

ggsave("figures/respirometry/resp_treatment_boxplot.png", r_plot2, dpi=300, w=7, h=5, units="in")
```

Plot as a box plot by cohort. 
```{r}
r_plot2a<-PRdata %>%
    
    ggplot(., aes(x = as.factor(Meas.Temp), y = R.nmol.org.min)) +
    facet_wrap(~Cohort)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=4, position = position_jitterdodge(0.2)) + 
    geom_boxplot(aes(colour=Treatment.Temp), fill=NA, position = position_dodge(0.8), outlier.size = 0)+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot2a

ggsave("figures/respirometry/resp_treatment_boxplot_cohort.png", r_plot2a, dpi=300, w=7, h=5, units="in")
```

Plot data by run. 
```{r}
r_plot3<-PRdata %>%
    
    ggplot(., aes(x = as.factor(Run), y = R.nmol.org.min)) +
    facet_wrap(~Cohort)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=4, position = position_jitterdodge(0.2)) + 
    geom_boxplot(aes(colour=Treatment.Temp), fill=NA, position = position_dodge(0.8), outlier.size = 0)+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot3

ggsave("figures/respirometry/resp_treatment_boxplot_per_run.png", r_plot3, dpi=300, w=7, h=5, units="in")
```

Plot data by run and cohort. 
```{r}
r_plot3a<-PRdata %>%
    
    ggplot(., aes(x = as.factor(Run), y = R.nmol.org.min)) +
    facet_wrap(~Cohort)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(fill=Treatment.Temp, colour=Treatment.Temp), size=4, position = position_jitterdodge(0.2)) + 
    geom_boxplot(aes(colour=Treatment.Temp), fill=NA, position = position_dodge(0.8), outlier.size = 0)+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue", "red","gray"))+
    scale_color_manual(name="Treatment", values=c("blue", "red","gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot3a

ggsave("figures/respirometry/resp_treatment_boxplot_per_run_cohort.png", r_plot3a, dpi=300, w=7, h=5, units="in")
```


# **Analyze data**    

## Respiration     

Build linear mixed effect model and examine for Respiration.      
```{r, results=TRUE, warning=FALSE, message=FALSE}
Rmodel1<-aov(log(1+R.nmol.org.min)~Meas.Temp*Treatment.Temp*Cohort, data=PRdata) 
summary(Rmodel1)
```
There is an effect of cohort, but not temperature or treatment or interactions. 

Check assumptions of model for residual normality and variance. Passes assumptions.    

```{r, results=TRUE, warning=FALSE, message=FALSE}
qqPlot(residuals(Rmodel1))
leveneTest(residuals(Rmodel1)~Meas.Temp*Treatment.Temp*Cohort, data=PRdata)
```

### Generate summary tables of mean and SE for all variables  

Generate summary of all respiration data.  

```{r}
summary<-PRdata%>%
  group_by(Meas.Temp, Treatment.Temp, Cohort)%>%
  summarise(N=length(R.nmol.org.min),
            Mean_R=mean(R.nmol.org.min), 
            SE_R=sd(R.nmol.org.min)/sqrt(length(R.nmol.org.min))); summary

summary%>%
  write_csv(., "output/mean_respiration.csv")
```