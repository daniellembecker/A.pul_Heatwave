---
title: "Univariate analysis of heatwave time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
edited by: "DM Becker-Polinski"
date: "20220830"
output: github_document
editor_options: 
  chunk_output_type: consoles
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_physiological_data.Rmd  
```{r}
master<-read.csv("timeseries_analysis/Output/master_timeseries.csv")

#remove notes column to remove NAs
master <- master[, -28]  # Remove the 28th column

```

# Univariate Responses  

Plot univariate response plots and then generate panel of all plots at the end of this section. Individual plots will not be displayed.  

### Plot: Symbiont Densities
 
View by treatment and timepoint.
```{r}

#remove outlier cells.cm for plot from TP3
master.sym <- master %>%
  filter(cells.cm2 < 3000000)

#create plot
symbplot_cm2<-master.sym %>%
  filter(!is.na(cells.cm2)) %>%
  filter(!is.na(timepoint))%>%
  select(fragment_ID, timepoint, treatment, cells.cm2)%>%
  
  ggplot(., aes(x = timepoint, y = cells.cm2, fill = treatment)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = c("blue", "red", "gray"), labels=c("ambient", "hot", "initial"))+
    labs(fill = "Treatment") +
    #facet_wrap(~timepoint) +
    xlab("Timepoint") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(legend.position = c(.95, .90),
    legend.justification = c("right", "top"),
      legend.title=element_text(face="bold", size=30),
      legend.text=element_text(size=28),
      axis.title=element_text(face="bold", size=30),
      axis.text=element_text(size=30, color="black"), 
      strip.text.x=element_text(face="italic", size=20)
      ); symbplot_cm2
```

### Plot: Host Protein   

View by treatment and timepoint.    
```{r}

#remove outlier host prot mg.cm2 for plot from TP3, TP5, and TP1
master.host.prot <- master %>%
  filter(host_prot_mg.cm2 < 1.00)

master.host.prot <- master.host.prot %>%
  filter(host_prot_mg.cm2 > 0.20)

#create plot
host_prot_cm2<-master.host.prot %>%
  filter(!is.na(host_prot_mg.cm2)) %>%
  filter(!is.na(timepoint))%>%
  select(fragment_ID, timepoint, treatment, host_prot_mg.cm2)%>%
  
  ggplot(., aes(x = timepoint, y = host_prot_mg.cm2, fill = treatment)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = c("blue", "red", "gray"), labels=c("ambient", "hot", "initial"))+
    labs(fill = "Treatment") +
    #facet_wrap(~timepoint) +
    xlab("Timepoint") + 
    ylab(expression(bold(paste("Host Protein ( mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=30),
      legend.text=element_text(size=28),
      legend.position = "none",
      axis.title=element_text(face="bold", size=30),
      axis.text=element_text(size=30, color="black"), 
      strip.text.x=element_text(face="italic", size=20)
      ); host_prot_cm2
```

### Plot: Holobiont protein  

View by treatment and timepoint.   
```{r}
#remove outlier holo prot mg.cm2 for plot from TP3, TP5
master.holo.prot <- master %>%
  filter(holobiont_prot_mg.cm2 < 1.25)

#create plot
holobiont_prot_cm2<-master.holo.prot %>%
  filter(!is.na(holobiont_prot_mg.cm2)) %>%
  filter(!is.na(timepoint))%>%
  select(fragment_ID, timepoint, treatment, holobiont_prot_mg.cm2)%>%
  
  ggplot(., aes(x = timepoint, y = holobiont_prot_mg.cm2, fill = treatment)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = c("blue", "red", "gray"), labels=c("ambient", "hot", "initial"))+
    labs(fill = "Treatment") +
    #facet_wrap(~timepoint) +
    xlab("Timepoint") + 
    ylab(expression(bold(paste("Holobiont Protein (mg cm"^-2, ")"))))+
    theme_classic() + 
     theme(
      legend.title=element_text(face="bold", size=20),
      legend.text=element_text(size=20),
      legend.position = "none",
      axis.title=element_text(face="bold", size=30),
      axis.text=element_text(size=30, color="black"), 
      strip.text.x=element_text(face="italic", size=20)
      ); holobiont_prot_cm2
```

### Plot: CHL-a

View by treatment and timepoint.   
```{r}
#remove outlier chla.ug cm2 for plot from TP3, TP5
master.chl <- master %>%
  filter(chla.ug.cm2 < 5.50)

#create plot
chla_cm2<-master.chl %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(timepoint))%>%
  select(fragment_ID, timepoint, treatment, chla.ug.cm2)%>%
  
  ggplot(., aes(x = timepoint, y = chla.ug.cm2, fill = treatment)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = c("blue", "red", "gray"), labels=c("ambient", "hot", "initial"))+
    labs(fill = "Treatment") +
    #facet_wrap(~timepoint) +
    xlab("Timepoint") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=20),
      legend.text=element_text(size=20),
      legend.position = "none",
      axis.title=element_text(face="bold", size=30),
      axis.text=element_text(size=30, color="black"), 
      strip.text.x=element_text(face="italic", size=20)
      ); chla_cm2
```

### Plot: CHL-c

View by treatment and timepoint.   
```{r}
# Define the specific timepoint
specific_timepoint <- "TP5"

# Define the chlc2.ug.cm2 threshold for outlier detection
threshold <- 1.88

# Filter the data to remove the outlier point at timepoint 5
filtered_master <- master %>%
  filter(!(timepoint == specific_timepoint & chlc2.ug.cm2 > threshold))

#create plot
chlc_prot_cm2<-filtered_master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(timepoint))%>%
  select(fragment_ID, timepoint, treatment, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = timepoint, y = chlc2.ug.cm2, fill = treatment)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = c("blue", "red", "gray"), labels=c("ambient", "hot", "initial"))+
    labs(fill = "Treatment") +
    #facet_wrap(~timepoint) +
    xlab("Timepoint") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=20),
      legend.text=element_text(size=20),
      legend.position = "none",
      axis.title=element_text(face="bold", size=30),
      axis.text=element_text(size=30, color="black"), 
      strip.text.x=element_text(face="italic", size=20)
      ); chlc_prot_cm2
```


Join all plots for each normalization together.  

```{r}
phys_figure<-plot_grid(symbplot_cm2, chla_cm2, chlc_prot_cm2, host_prot_cm2, holobiont_prot_cm2, ncol=3, nrow=2, labels = c('A', 'B', 'C', 'D', 'E'),rel_heights= c(1,1,1,1), rel_widths = c(1,1,1,1.2), label_y=1, align="h", label_size = 50)

ggsave(filename="timeseries_analysis/Figures/Phys_Figure.pdf", plot=phys_figure, dpi=300, width=30, height=25, units="in")
ggsave(filename="timeseries_analysis/Figures/Phys_Figure.png", plot=phys_figure, dpi=300, width=30, height=25, units="in")
```

### Univariate Analysis  

Build a mixed model for univariate analysis and examine data distribution.

# For symbiont densities 

`sym_model<-lmer(cells.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
sym_model<-lmer(cells.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master)
qqPlot(residuals(sym_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sym_model<-lmer(log(cells.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
sym_model<-lmer(log(cells.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master))
qqPlot(residuals(sym_model))
```

Generate a Type III Anova of model.    

```{r}
anova(sym_model, type="III")
```

Main effects of treatment and timepoint are significant but timepoint:treatment are not.

Type III Analysis of Variance Table with Satterthwaite's method
                        Sum Sq    Mean Sq NumDF      DenDF F value   Pr(>F)   
timepoint           2.8024e+12 7.0059e+11     4        Inf  3.9404 0.003356 **
treatment           1.0416e+12 1.0416e+12     1 1.0654e+42  5.8583 0.015504 * 
timepoint:treatment 4.6172e+11 1.5391e+11     3        Inf  0.8656 0.458037 

# For chla

`chla_model<-lmer(chla.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(chla.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master))` 

```{r}
chla_model<-lmer(log(chla.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master))
qqPlot(residuals(chla_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model, type="III")
```

Main effects of timepoint are significant but timepoint:treatment are not.

Type III Analysis of Variance Table with Satterthwaite's method
                    Sum Sq Mean Sq NumDF DenDF F value    Pr(>F)    
timepoint           69.418 17.3544     4   111 16.4514 1.303e-10 ***
treatment            1.558  1.5576     1   111  1.4766    0.2269    
timepoint:treatment  2.615  0.8718     3   111  0.8264    0.4820   

# For chlc

`chlc_model<-lmer(chlc2.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
chlc_model<-lmer(chlc2.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master)
qqPlot(residuals(chlc_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc_model<-lmer(log(chlc2.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master))` 

```{r}
chlc_model<-lmer(log(chlc2.ug.cm2~timepoint*treatment+(1|colony_ID), na.action=na.omit, data=master))
qqPlot(residuals(chlc_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc_model, type="III")
```

Main effects of timepoint are significant but timepoint:treatment are not.

Type III Analysis of Variance Table with Satterthwaite's method
                     Sum Sq Mean Sq NumDF DenDF F value Pr(>F)    
timepoint           189.130  47.282     4   111 34.7826 <2e-16 ***
treatment             1.038   1.038     1   111  0.7635 0.3841    
timepoint:treatment   2.628   0.876     3   111  0.6445 0.5880  

# For host protein

`host_prot_model<-lmer(host_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
host_prot_model<-lmer(host_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)
qqPlot(residuals(host_prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`host_prot_model<-lmer(log(host_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master))` 

```{r}
host_prot_model<-lmer(log(host_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master))
qqPlot(residuals(host_prot_model))
```

Generate a Type III Anova of model.    

```{r}
anova(sym_model, type="III")
```

Main effects of treatment and timepoint are significant but timepoint:treatment are not.

Type III Analysis of Variance Table with Satterthwaite's method
                        Sum Sq    Mean Sq NumDF      DenDF F value   Pr(>F)   
timepoint           2.8024e+12 7.0059e+11     4        Inf  3.9404 0.003356 **
treatment           1.0416e+12 1.0416e+12     1 1.0654e+42  5.8583 0.015504 * 
timepoint:treatment 4.6172e+11 1.5391e+11     3        Inf  0.8656 0.458037  

# For holo protein

`holo_prot_model<-lmer(holobiont_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)` 

```{r}
holo_prot_model<-lmer(holobiont_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master)
qqPlot(residuals(holo_prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`holo_prot_model<-lmer(log(holobiont_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master))` 

```{r}
holo_prot_model<-lmer(log(holobiont_prot_ug.cm2~timepoint+(1|colony_ID), na.action=na.omit, data=master))
qqPlot(residuals(holo_prot_model))
```

Generate a Type III Anova of model.    

```{r}
anova(sym_model, type="III")
```

Main effects of treatment and timepoint are significant but timepoint:treatment are not.

Type III Analysis of Variance Table with Satterthwaite's method
                        Sum Sq    Mean Sq NumDF      DenDF F value   Pr(>F)   
timepoint           2.8024e+12 7.0059e+11     4        Inf  3.9404 0.003356 **
treatment           1.0416e+12 1.0416e+12     1 1.0654e+42  5.8583 0.015504 * 
timepoint:treatment 4.6172e+11 1.5391e+11     3        Inf  0.8656 0.458037  

